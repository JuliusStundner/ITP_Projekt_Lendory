@page "/createItem"
@using Lendory.Data
@using Lendory.Entities
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext _context
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@using Microsoft.AspNetCore.Components.Authorization

<PageTitle>Create Item</PageTitle>

@if (_isAdmin)
{
    <MudAlert Severity="Severity.Error" Variant="Variant.Filled">
        Dieser Bereich ist nur für Admins!
    </MudAlert>
}
else
{
    <MudPaper Elevation="4" Class="pa-6 mx-auto mt-6" Style="max-width: 520px;">

        <MudText Typo="Typo.h5" Class="mb-4">
            Neues Item erstellen
        </MudText>

        <!-- NAME -->
        <MudTextField T="string"
                      Label="Name"
                      @bind-Value="_item.Name"
                      Variant="Variant.Outlined"
                      Required="true" />

        <!-- DESCRIPTION -->
        <MudTextField T="string"
                      Label="Beschreibung"
                      @bind-Value="_item.Description"
                      Lines="3"
                      Variant="Variant.Outlined"
                      Class="mt-3" />

        <!-- CATEGORY -->
        <MudSelect T="ItemCategory"
                   Label="Kategorie"
                   @bind-Value="selectedCategory"
                   Variant="Variant.Outlined"
                   Class="mt-3"
                   ToStringFunc="c => c.Name"
                   Required="true">

            @foreach (var c in _categories)
            {
                <MudSelectItem Value="@c">@c.Name</MudSelectItem>
            }
        </MudSelect>

        <!-- CONDITION -->
        <MudTextField T="string"
                      Label="Zustand"
                      @bind-Value="_item.Condition"
                      Variant="Variant.Outlined"
                      Class="mt-3" />

        <MudDivider Class="my-4" />

        <InputFile OnChange="OnFileSelected" accept="image/*" />
        <br/>
        @if (_previewImage != null)
        {
            <img src="@_previewImage" style="max-width:200px; border-radius:12px;" />
        }

        
        <div class="d-flex justify-end gap-2">
            <MudButton Variant="Variant.Text"
                       Color="Color.Default"
                       ButtonType="ButtonType.Button"
                       OnClick="Cancel">
                Abbrechen
            </MudButton>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       ButtonType="ButtonType.Button"
                       OnClick="Save">
                Speichern
            </MudButton>
        </div>

    </MudPaper>
}

@code {
    private Item _item = new();
    private List<ItemCategory> _categories = new();
    private bool _isAdmin;
    private ItemCategory? selectedCategory;
    IBrowserFile? _file;
    string? _previewImage;

    async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        _file = e.File;

        using var stream = _file.OpenReadStream(5_000_000);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);

        _previewImage = $"data:{_file.ContentType};base64,{Convert.ToBase64String(ms.ToArray())}";
    }

    public async Task<string> SaveImageAsync(IBrowserFile file)
    {
        var allowed = new[] { "image/jpeg", "image/png", "image/webp" };
        if (!allowed.Contains(file.ContentType))
            throw new Exception("Ungültiger Bildtyp");

        var fileName = $"{Guid.NewGuid()}{Path.GetExtension(file.Name)}";
        var path = Path.Combine("wwwroot/uploads/items", fileName);

        await using var fs = new FileStream(path, FileMode.Create);
        await file.OpenReadStream(5_000_000).CopyToAsync(fs);

        return $"/uploads/items/{fileName}";
    }

    
    protected override async Task OnInitializedAsync()
    { 
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        _isAdmin = user.IsInRole("Admin");
        
        _categories = await _context.Categories
            .OrderBy(c => c.CategoryId)
            .ToListAsync();
        // default date
        _item.DateAdded = DateTime.Now;
    }

    private async Task Save()
    {
        if (selectedCategory is null)
            return;

        _item.CategoryId = selectedCategory.CategoryId;

        // 👉 WENN ein Bild ausgewählt wurde → speichern
        if (_file != null)
        {
            _item.ImageUrl = await SaveImageAsync(_file);
        }

        await _context.Items.AddAsync(_item);
        await _context.SaveChangesAsync();

        Nav.NavigateTo("/main");
    }

    
    private void Cancel()
    {
        Nav.NavigateTo("/main");
    }
}
