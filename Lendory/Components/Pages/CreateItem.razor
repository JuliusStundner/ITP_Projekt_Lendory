@page "/createItem"
@using Lendory.Data
@using Lendory.Entities
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms

@inject ApplicationDbContext _context
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Create Item</PageTitle>

@if (!_isAdmin)
{
    <MudAlert Severity="Severity.Error" Variant="Variant.Filled">
        Dieser Bereich ist nur für Admins!
    </MudAlert>
}
else
{
    <MudPaper Elevation="4" Class="pa-6 mx-auto mt-6" Style="max-width: 520px;">

        <MudText Typo="Typo.h5" Class="mb-4">
            Neues Item erstellen
        </MudText>

        <!-- NAME -->
        <MudTextField T="string"
                      Label="Name"
                      @bind-Value="_item.Name"
                      Variant="Variant.Outlined"
                      Required="true" />

        <!-- DESCRIPTION -->
        <MudTextField T="string"
                      Label="Beschreibung"
                      @bind-Value="_item.Description"
                      Lines="3"
                      Variant="Variant.Outlined"
                      Class="mt-3" />

        <!-- CATEGORY -->
        <MudSelect T="ItemCategory"
                   Label="Kategorie"
                   @bind-Value="selectedCategory"
                   Variant="Variant.Outlined"
                   Class="mt-3"
                   ToStringFunc="c => c.Name"
                   Required="true">

            @foreach (var c in _categories)
            {
                <MudSelectItem Value="@c">@c.Name</MudSelectItem>
            }
        </MudSelect>

        <!-- CONDITION -->
        <MudTextField T="string"
                      Label="Zustand"
                      @bind-Value="_item.Condition"
                      Variant="Variant.Outlined"
                      Class="mt-3" />

        <MudDivider Class="my-4" />

        <!-- IMAGE UPLOAD -->
        <InputFile OnChange="OnFileSelected" accept="image/*" />

        @if (_imageError)
        {
            <MudText Color="Color.Error" Typo="Typo.caption">
                Bitte ein Bild auswählen
            </MudText>
        }

        @if (_previewImage != null)
        {
            <img src="@_previewImage"
                 style="max-width:200px; margin-top:12px; border-radius:12px;" />
        }

        <MudDivider Class="my-4" />

        <!-- ACTIONS -->
        <div class="d-flex justify-end gap-2">
            <MudButton Variant="Variant.Text"
                       Color="Color.Default"
                       OnClick="Cancel">
                Abbrechen
            </MudButton>

            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       Disabled="@(_file == null)"
                       OnClick="Save">
                Speichern
            </MudButton>
        </div>

    </MudPaper>
}

@code {

    // ===================== STATE =====================

    private Item _item = new();
    private List<ItemCategory> _categories = new();
    private ItemCategory? selectedCategory;

    private bool _isAdmin;

    private IBrowserFile? _file;
    private string? _previewImage;

    private bool _imageError;

    // ===================== LIFECYCLE =====================

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        _isAdmin = user.IsInRole("Admin");

        _categories = await _context.Categories
            .OrderBy(c => c.CategoryId)
            .ToListAsync();

        _item.DateAdded = DateTime.Now;
    }

    // ===================== FILE HANDLING =====================

    async Task OnFileSelected(InputFileChangeEventArgs e)
    {
        _file = e.File;
        _imageError = false;

        using var stream = _file.OpenReadStream(5_000_000);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);

        _previewImage = $"data:{_file.ContentType};base64,{Convert.ToBase64String(ms.ToArray())}";
    }

    async Task<string> SaveImageAsync(IBrowserFile file)
    {
        var allowed = new[] { "image/jpeg", "image/png", "image/webp" };
        if (!allowed.Contains(file.ContentType))
            throw new Exception("Ungültiger Bildtyp");

        var fileName = $"{Guid.NewGuid()}{Path.GetExtension(file.Name)}";
        var path = Path.Combine("wwwroot/uploads/items", fileName);

        Directory.CreateDirectory(Path.GetDirectoryName(path)!);

        await using var fs = new FileStream(path, FileMode.Create);
        await file.OpenReadStream(5_000_000).CopyToAsync(fs);

        return $"/uploads/items/{fileName}";
    }

    // ===================== ACTIONS =====================

    private async Task Save()
    {
        if (_file == null)
        {
            _imageError = true;
            return;
        }

        if (selectedCategory == null)
            return;

        _item.CategoryId = selectedCategory.CategoryId;
        _item.ImageUrl = await SaveImageAsync(_file);

        await _context.Items.AddAsync(_item);
        await _context.SaveChangesAsync();

        Nav.NavigateTo("/");
    }

    private void Cancel()
    {
        Nav.NavigateTo("/");
    }
}
